SELECT `BIGRAM`, COUNT() AS `Tot_Occ`, SUM(`TotKeypress`) AS `Tot_KeyPr`, AVG(`TotKeypress`) AS `mean_KeyPr`, STDEV(`TotKeypress`) AS `std_KeyPr`, AVG(`IKI`) AS `mean_IKI`, STDEV(`IKI`) AS `std_IKI`
FROM (SELECT `LHS`.`PARTICIPANT_ID` AS `PARTICIPANT_ID`, `LHS`.`TEST_SECTION_ID` AS `TEST_SECTION_ID`, `LHS`.`SENTENCE` AS `SENTENCE`, `LHS`.`USER_INPUT` AS `USER_INPUT`, `LHS`.`KEYSTROKE_ID` AS `KEYSTROKE_ID`, `LHS`.`PRESS_TIME` AS `PRESS_TIME`, `LHS`.`RELEASE_TIME` AS `RELEASE_TIME`, `LHS`.`LETTER.x` AS `LETTER.x`, `LHS`.`KEYCODE` AS `KEYCODE`, `LHS`.`current_position` AS `current_position`, `LHS`.`cum_keystrokes` AS `cum_keystrokes`, `LHS`.`keystrokes` AS `keystrokes`, `LHS`.`LETTER.y` AS `LETTER.y`, `LHS`.`IsValidBigram` AS `IsValidBigram`, `LHS`.`BIGRAM` AS `BIGRAM`, `LHS`.`TotKeypress` AS `TotKeypress`, `LHS`.`IKI` AS `IKI`, `RHS`.`AVG_WPM` AS `AVG_WPM`, `RHS`.`WPM_SEGMENT` AS `WPM_SEGMENT`, `RHS`.`ENGLISH_SPEAKING` AS `ENGLISH_SPEAKING`
  FROM (SELECT `PARTICIPANT_ID`, `TEST_SECTION_ID`, `SENTENCE`, `USER_INPUT`, `KEYSTROKE_ID`, `PRESS_TIME`, `RELEASE_TIME`, `LETTER.x`, `KEYCODE`, `current_position`, `cum_keystrokes`, `keystrokes`, `LETTER.y`, `IsValidBigram`, CASE WHEN (`IsValidBigram` = 1) THEN (`LETTER.y` || LEAD(`LETTER.y`, 1, NULL) OVER (ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL))) WHEN NOT(`IsValidBigram` = 1) THEN (NULL) END AS `BIGRAM`, `keystrokes` + LEAD(`keystrokes`, 1, NULL) OVER (ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL)) + 2.0 AS `TotKeypress`, LEAD(CAST(`PRESS_TIME` AS REAL), 1, NULL) OVER (ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL)) - CAST(`PRESS_TIME` AS REAL) AS `IKI`
  FROM (SELECT `PARTICIPANT_ID`, `TEST_SECTION_ID`, `SENTENCE`, `USER_INPUT`, `KEYSTROKE_ID`, `PRESS_TIME`, `RELEASE_TIME`, `LETTER.x`, `KEYCODE`, `current_position`, `cum_keystrokes`, `keystrokes`, `LETTER.y`, CASE WHEN (`TEST_SECTION_ID` = LEAD(`TEST_SECTION_ID`, 1, NULL) OVER (ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL)) AND CAST(`KEYCODE` AS REAL) >= 65.0 AND CAST(`KEYCODE` AS REAL) <= 90.0 AND CAST(LEAD(`KEYCODE`, 1, NULL) OVER (ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL)) AS REAL) >= 65.0 AND CAST(LEAD(`KEYCODE`, 1, NULL) OVER (ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL)) AS REAL) <= 90.0) THEN (1) WHEN NOT(`TEST_SECTION_ID` = LEAD(`TEST_SECTION_ID`, 1, NULL) OVER (ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL)) AND CAST(`KEYCODE` AS REAL) >= 65.0 AND CAST(`KEYCODE` AS REAL) <= 90.0 AND CAST(LEAD(`KEYCODE`, 1, NULL) OVER (ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL)) AS REAL) >= 65.0 AND CAST(LEAD(`KEYCODE`, 1, NULL) OVER (ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL)) AS REAL) <= 90.0) THEN (0) END AS `IsValidBigram`
  FROM (SELECT `LHS`.`PARTICIPANT_ID` AS `PARTICIPANT_ID`, `LHS`.`TEST_SECTION_ID` AS `TEST_SECTION_ID`, `LHS`.`SENTENCE` AS `SENTENCE`, `LHS`.`USER_INPUT` AS `USER_INPUT`, `LHS`.`KEYSTROKE_ID` AS `KEYSTROKE_ID`, `LHS`.`PRESS_TIME` AS `PRESS_TIME`, `LHS`.`RELEASE_TIME` AS `RELEASE_TIME`, `LHS`.`LETTER` AS `LETTER.x`, `LHS`.`KEYCODE` AS `KEYCODE`, `LHS`.`current_position` AS `current_position`, `LHS`.`cum_keystrokes` AS `cum_keystrokes`, `LHS`.`keystrokes` AS `keystrokes`, `RHS`.`LETTER` AS `LETTER.y`
  FROM (SELECT *
  FROM (SELECT `PARTICIPANT_ID`, `TEST_SECTION_ID`, `SENTENCE`, `USER_INPUT`, `KEYSTROKE_ID`, `PRESS_TIME`, `RELEASE_TIME`, `LETTER`, `KEYCODE`, `current_position`, `cum_keystrokes`, CASE WHEN (`current_position` = 1.0) THEN (0.0) WHEN NOT(`current_position` = 1.0) THEN ((`cum_keystrokes` - `current_position`) - (LAG(`cum_keystrokes`, 1, NULL) OVER (ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL)) - LAG(`current_position`, 1, NULL) OVER (ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL)))) END AS `keystrokes`
  FROM (SELECT `PARTICIPANT_ID`, `TEST_SECTION_ID`, `SENTENCE`, `USER_INPUT`, `KEYSTROKE_ID`, `PRESS_TIME`, `RELEASE_TIME`, `LETTER`, `KEYCODE`, `current_position`, `cum_keystrokes`
  FROM (SELECT `PARTICIPANT_ID`, `TEST_SECTION_ID`, `SENTENCE`, `USER_INPUT`, `KEYSTROKE_ID`, `PRESS_TIME`, `RELEASE_TIME`, `LETTER`, `KEYCODE`, `current_position`, `cum_keystrokes`, MAX(`cum_keystrokes`) OVER (PARTITION BY `USER_INPUT`, `current_position`) AS `zzz5`
  FROM (SELECT `PARTICIPANT_ID`, `TEST_SECTION_ID`, `SENTENCE`, `USER_INPUT`, `KEYSTROKE_ID`, `PRESS_TIME`, `RELEASE_TIME`, `LETTER`, `KEYCODE`, `current_position`, `cum_keystrokes`
  FROM (SELECT `PARTICIPANT_ID`, `TEST_SECTION_ID`, `SENTENCE`, `USER_INPUT`, `KEYSTROKE_ID`, `PRESS_TIME`, `RELEASE_TIME`, `LETTER`, `KEYCODE`, `current_position`, `cum_keystrokes`, MAX(`current_position`) OVER (PARTITION BY `USER_INPUT`) AS `zzz6`
  FROM (SELECT `PARTICIPANT_ID`, `TEST_SECTION_ID`, `SENTENCE`, `USER_INPUT`, `KEYSTROKE_ID`, `PRESS_TIME`, `RELEASE_TIME`, `LETTER`, `KEYCODE`, SUM(CASE WHEN (`KEYCODE` = '8') THEN (-1.0) WHEN NOT(`KEYCODE` = '8') THEN (1.0) END) OVER (PARTITION BY `USER_INPUT` ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL) ROWS UNBOUNDED PRECEDING) AS `current_position`, ROW_NUMBER() OVER (PARTITION BY `USER_INPUT` ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL)) AS `cum_keystrokes`
  FROM (SELECT *
  FROM (SELECT * FROM `keystrokes` AS `LHS`
WHERE NOT EXISTS (
    SELECT 1 FROM `dbplyr_001` AS `RHS`
    WHERE (`LHS`.`TEST_SECTION_ID` = `RHS`.`TEST_SECTION_ID`)
  ))
ORDER BY `USER_INPUT`, CAST(`PRESS_TIME` AS REAL))))
WHERE (`KEYCODE` != '8' AND `current_position` <= `zzz6`)))
WHERE (`cum_keystrokes` = `zzz5`)))
WHERE (`KEYCODE` = '13' OR `KEYCODE` = '32' OR `KEYCODE` = '48' OR `KEYCODE` = '49' OR `KEYCODE` = '50' OR `KEYCODE` = '51' OR `KEYCODE` = '52' OR `KEYCODE` = '53' OR `KEYCODE` = '54' OR `KEYCODE` = '55' OR `KEYCODE` = '56' OR `KEYCODE` = '57' OR `KEYCODE` = '65' OR `KEYCODE` = '66' OR `KEYCODE` = '67' OR `KEYCODE` = '68' OR `KEYCODE` = '69' OR `KEYCODE` = '70' OR `KEYCODE` = '71' OR `KEYCODE` = '72' OR `KEYCODE` = '73' OR `KEYCODE` = '74' OR `KEYCODE` = '75' OR `KEYCODE` = '76' OR `KEYCODE` = '77' OR `KEYCODE` = '78' OR `KEYCODE` = '79' OR `KEYCODE` = '80' OR `KEYCODE` = '81' OR `KEYCODE` = '82' OR `KEYCODE` = '83' OR `KEYCODE` = '84' OR `KEYCODE` = '85' OR `KEYCODE` = '86' OR `KEYCODE` = '87' OR `KEYCODE` = '88' OR `KEYCODE` = '89' OR `KEYCODE` = '90' OR `KEYCODE` = '96' OR `KEYCODE` = '97' OR `KEYCODE` = '98' OR `KEYCODE` = '99' OR `KEYCODE` = '100' OR `KEYCODE` = '101' OR `KEYCODE` = '102' OR `KEYCODE` = '103' OR `KEYCODE` = '104' OR `KEYCODE` = '105' OR `KEYCODE` = '106' OR `KEYCODE` = '107' OR `KEYCODE` = '109' OR `KEYCODE` = '110' OR `KEYCODE` = '111' OR `KEYCODE` = '186' OR `KEYCODE` = '187' OR `KEYCODE` = '188' OR `KEYCODE` = '189' OR `KEYCODE` = '190' OR `KEYCODE` = '191' OR `KEYCODE` = '219' OR `KEYCODE` = '220' OR `KEYCODE` = '221' OR `KEYCODE` = '222')) AS `LHS`
LEFT JOIN `dbplyr_002` AS `RHS` ON (`LHS`.`KEYCODE` = `RHS`.`KEYCODE`)))) AS `LHS`
LEFT JOIN `dbplyr_003` AS `RHS` ON (`LHS`.`PARTICIPANT_ID` = `RHS`.`PARTICIPANT_ID`))
GROUP BY `BIGRAM`
