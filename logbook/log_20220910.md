
# [Referentially transparent CRUD](https://cjohansen.no/referentially-transparent-crud/) id=g13339

## Reading Data

Datomic'de veritabanı, bildiğimiz veritabanından farklı anlamda kullanılır. Datomic için veritabanı, "büyük" veritabanının belirli bir alt kümesidir (subset of the facts).

`(d/db conn)` ile sağlanan görünümü (view) kullanarak veritabanının belli bir durumunu çekersin.

Veritabanı sabit (immutable) bir değer olunca, tüm okuma işlemleri saf (pure) hale gelir. Dolayısıyla bu fonksiyonlar referanssal şeffaf (referentially transparent) olurlar.

## Writing Data

Veri yazmak `(d/transact conn)` ile yapılır. Fakat `conn` yani peer connection objesi sabit değildir.

Datomic işlemleri (transaction) ya transactor fonksiyonu çağırlarından veya entity maplerden oluşur. Tüm güncellemeleri tek bir işlem içine koyarız. Bu tek işlemi de tek bir veri yapısına (data structure) koyup göndeririz. Böylece bu tek fonksiyon çağrısı dışındaki tüm işlemler yan etkisiz olur.

### The data processing contract

Veri güncelleyen fonksiyonlar şu işlemleri de genellikle yapar:

- Veri geçerleme (validation)
- Ek veri sorgulama (look up)
- Veri işleme (process)
- Değişiklikleri commit etme

Bu adımlardan birinde sorun çıkması, güncellemeleri iptal edebilir. Dolayısıyla veri güncelleyen fonksiyonların sadece işlem verisini dönmesi yetmez, potansiyel hataları da bildirmesi gerekir. Bunun için bir kontrat tanımlayalım:

```clj
{:command/success? true ;; or false
 :command/validation-data {}
 :command/tx-data []
 :command/error {}}
```

Eğer komut hata dönerse, ya `validation-data` ya da `error` mesajlarından en az birisi olmalı. Eğer başarılı çalışırsa, o zaman `tx-data` olmalı. Bunu da `transact` fonksiyonuna göndeririz: `(d/transact conn tx-data)`


