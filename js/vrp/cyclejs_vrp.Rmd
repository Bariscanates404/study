---
title: "CycleJS Implementation in VRP"
date: 2018-02-27T18:23:18+03:00 
draft: true
description: ""
tags:
categories: javascript, cyclejs
type: post
url:
author: "Mert Nuhoglu"
output:
  html_document:
    css: styles.css
blog: mertnuhoglu.com
resource_files:
- 
path: ~/projects/study/js/vrp/cyclejs_vrp.Rmd
state: wip
---

<style>
  .main-container {
    max-width: 1600px !important;
  }
</style>

``` {r set-options}
options(width = 150)
options(max.print = 30)
``` 

## v01: Calling and Viewing Data from a Simple REST API 

First run the web service:

``` bash
json-server --watch ex/db.json
open ex/cyclejs_vrp_ex01.html
``` 

Clicking the button results in:

<div class="app" data-vivaldi-spatnav-clickable="1"><div><button class="get-first">Get first comment</button><div class="comment-details"><h4 class="comment-body">some comment</h4><h4 class="comment-id">1</h4></div></div></div>

Note: The following code variants have different outputs:

      h4('.comment-body', firstComment.body),
      h4('.comment-id', `${firstComment.id}`)
      //h4('.comment-json', `${firstComment}`)
      //> [object Object]
      //h4('.comment-json', firstComment.id)
      //> TypeError: Cannot create property 'className' on number '1'

The code of this web page:

``` {bash}  
cat ex/cyclejs_vrp_ex01.js
``` 

## Calling a Postgrest REST API

Run the server embedded in docker container:

    $ docker-compose up -d # wait for 5-10s before running the next command

Make a basic request:

    $ curl http://localhost:8080/rest/todos?select=id
    [{"id":1},{"id":3},{"id":6}]

## Consuming Postgrest REST API in CycleJS App

``` bash
docker-compose up -d 
open ex/cyclejs_vrp_ex02.html
``` 

`ex/cyclejs_vrp_ex02.js`

``` js
function main(sources) {
  const clickEvent$ = sources.DOM
    .select('.get-first').events('click');
  
  const request$ = clickEvent$.map(() => {
    return {
      url: 'http://localhost:8080/rest/todos?select=id',
      method: 'GET',
    };
  });
  
  const response$$ = sources.HTTP
    .filter(response$ => response$.request.url ===
           'http://localhost:8080/rest/todos?select=id');
  
  const response$ = response$$.switch();
  const json$ = response$.map(response => response.body)
    .startWith(null);
  
  return {
    DOM: json$.map(json =>
      div([
        button('.get-first', 'Get first comment'),
        json === null ? null : div('.comment-details', [
          h4('.comment-id', `${json[0].id}`)
        ])
      ])
    ),
    HTTP: request$,
  };
}

const drivers = {
  DOM: makeDOMDriver('#app'),
  HTTP: makeHTTPDriver(),
}

Cycle.run(main, drivers);
``` 

The response of REST API is as follows:

    $ curl http://localhost:8080/rest/todos?select=id
    [{"id":1},{"id":3},{"id":6}]

The view code that presents this JSON data:

    h4('.comment-id', `${json[0].id}`)

After clicking the button we get:

<div class="app"><button class="get-first">Get first comment</button><div class="comment-details"><h4 class="comment-id">1</h4></div></div>

## Consuming Actual Data in CycleJS App

Start database server and postgrest:

``` bash
dmd=~/projects/itr/itr_documentation/data_model
psk=~/codes/pg/khumbuicefall
cd $psk
docker-compose up -d
``` 

Generate schema and initial data:

``` bash
cd /Users/mertnuhoglu/projects/yumltordbschema
R
``` 

``` R
test_setup()
main_rdb_to_data_step01()
#> ~/projects/itr/itr_documentation/data_model/data/view/ddl.sql
#> ~/projects/itr/itr_documentation/data_model/data/sql/sql_insert/sql_insert_enum_var.sql
``` 

Manually edit `ddl_m.sql` by moving updated lines from `ddl.sql`:

``` vim
#> ~/projects/itr/itr_documentation/data_model/data/view/ddl.sql
:%s/\<BIGINT\>/INT/
``` 

Go to R console:

``` R
main_rdb_to_data_step02()
#> ~/projects/itr/itr_documentation/data_model/data/view/data.sql
``` 

Import initial data into database to check:

``` bash
cd ~/projects/itr/itr_documentation/data_model/data/view/
psql -d app -f init.sql
``` 

Move sql files to psk `${psk}/db/src` folder:

``` bash
cp ${dmd}/data/view/ddl_m.sql ${psk}/db/src/data/vrp_ddl_m.sql
cp ${dmd}/data/sql/sql_insert/sql_insert_enum_var.sql ${psk}/db/src/sample_data
cp ${dmd}/data/sql/sql_insert/sql_insert_enum_value.sql ${psk}/db/src/sample_data
cp ${dmd}/data/view/data.sql ${psk}/db/src/sample_data/vrp_data.sql
``` 

Edit psk sql files:

    data/schema.sql
      \ir vrp_ddl_m.sql
    init.sql
      \ir sample_data/sql_insert_enum_var.sql
      \ir sample_data/sql_insert_enum_value.sql
      \ir sample_data/vrp_data.sql
    api/schema.sql
      \ir vrp_views.sql
    api/vrp_views.sql
      create or replace view plan as
      select * from data.plan;
    authorization/privileges.sql
      grant select, insert, update, delete
      on api.plan
      to webuser;

Test from console:

``` bash
export JWT_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJyb2xlIjoid2VidXNlciJ9.uSsS2cukBlM6QXe4Y0H90fsdkJSGcle9b7p_kMV1Ymk
curl -H "Authorization: Bearer $JWT_TOKEN" http://localhost:8080/rest/plan?select=plan_id
``` 

Use in cyclejs:

``` js
const request$ = clickEvent$.map(() => {
  return {
    url: 'http://localhost:8080/rest/plan?select=plan_id',
    method: 'GET',
    headers: {
      "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJyb2xlIjoid2VidXNlciJ9.uSsS2cukBlM6QXe4Y0H90fsdkJSGcle9b7p_kMV1Ymk"
``` 

``` bash
open ex/cyclejs_vrp_ex03.html
``` 

### Table with CycleJs

``` bash
open ex/cyclejs_vrp_ex04.html
``` 

### Bundle it with ParcelJs

Source code in https://github.com/mertnuhoglu/study/js/vrp/ex/cyclejs_vrp/

``` bash
mkdir -p ex/cyclejs_vrp/ex05 && cd $_ && npm init -y && npm i parcel-bundler rxjs @cycle/rxjs-run @cycle/dom @cycle/http
``` 

`ex/cyclejs_vrp/ex05/package.json`

    "start": "parcel index.html",
    "build": "parcel build index.html --public-url ./",

removed

    "start": "cycle-scripts start",
    "build": "cycle-scripts build",

`ex/cyclejs_vrp/ex05/index.js`

Run `npm start`
 
Open http://localhost:1234

### Apply MVI Architecture

``` bash
mkdir -p ex/cyclejs_vrp/ex06 && cd $_ && npm init -y && npm i parcel-bundler rxjs @cycle/rxjs-run @cycle/dom @cycle/http
``` 

`ex/cyclejs_vrp/ex06/package.json`

    "start": "parcel index.html",
    "build": "parcel build index.html --public-url ./",

Edit `ex/cyclejs_vrp/ex06/index.js`

Run `npm start`
 
Open http://localhost:1234

``` js
function main(sources) {
  const json$ = model(sources.HTTP);
  return {
    DOM: view(json$),
    HTTP: intent(sources.DOM),
  };
}
``` 

### Split intent model view into Separate Files

``` bash
mkdir -p ex/cyclejs_vrp/ex07 && cd $_ && npm init -y && npm i --save-dev parcel-bundler && npm i xstream @cycle/run @cycle/dom @cycle/http
``` 

`ex/cyclejs_vrp/ex07/package.json`

    "start": "parcel src/index.html",
    "build": "parcel build src/index.html --public-url ./",

Start database server and postgrest:

``` bash
dmd=~/projects/itr/itr_documentation/data_model
psk=~/codes/pg/khumbuicefall
cd $psk
docker-compose up -d
``` 

Edit `ex/cyclejs_vrp/ex07/src/index.js`

``` js
import { run } from '@cycle/run';
import { makeDOMDriver } from '@cycle/dom';
import {makeHTTPDriver} from '@cycle/http';

import App from './components/app';

const main = App;

const drivers = {
  DOM: makeDOMDriver('#app'),
  HTTP: makeHTTPDriver(),
};

run(main, drivers);
``` 

Edit `ex/cyclejs_vrp/ex07/src/components/app/index.js`

``` js
import xs from 'xstream'
import {makeDOMDriver} from '@cycle/dom';
import model from './model';
import view from './view';
import intent, { Actions } from './intent';

export default function main(sources) {
  const json$ = model(sources.HTTP);
  return {
    DOM: view(json$),
    HTTP: intent(sources.DOM),
  };
}
``` 

Edit `ex/cyclejs_vrp/ex07/src/components/app/intent.js`

``` js
import xs from 'xstream';

export default function intent(dom$) {
  const clickEvent$ = dom$
    .select('.get-first').events('click')
    .startWith(null);

  const request$ = clickEvent$.map(() => {
    return {
      url: 'http://localhost:8080/rest/plan?select=plan_id,usr,depot_id',
      method: 'GET',
      headers: {
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJyb2xlIjoid2VidXNlciJ9.uSsS2cukBlM6QXe4Y0H90fsdkJSGcle9b7p_kMV1Ymk"
      }
    };
  });
  return request$;
}
``` 

Edit `ex/cyclejs_vrp/ex07/src/components/app/model.js`

``` js
import xs from 'xstream';

export default function model(http$) {
  const response$$ = http$.select();
  const response$ = response$$.flatten();
  const json$ = response$.map(response => response.body);
  return json$;
}
``` 

Edit `ex/cyclejs_vrp/ex07/src/components/app/view.js`

``` js
import xs from 'xstream';
import {button, h1, h4, a, div, table, thead, tbody, tr, td, th} from '@cycle/dom';

export default function view(json$) {
  return json$.
    map(json =>
      table([
        thead(
          tr([
            th('Plan Id'),
            th('Kullanıcı'),
            th('Depot Id')
          ])
        ),
        tbody(
          json.map(e => 
            tr([
              td(e.plan_id),
              td(e.usr),
              td(e.depot_id)
            ])
          )
        )
      ])
    )
}
``` 

Run `npm start`
 
Open http://localhost:1234

### Apply Onion Architecture

``` bash
mkdir -p ex/cyclejs_vrp/ex08 && cd $_ && npm init -y && pnpm i --save-dev parcel-bundler && npm i xstream @cycle/run @cycle/dom @cycle/http cycle-onionify cycle-storageify @cycle/storage
``` 

``` {bash}
cp -R ex/cyclejs_vrp/ex07/src/ ex/cyclejs_vrp/ex08/src/ 
``` 

`ex/cyclejs_vrp/ex08/package.json`

    "start": "parcel src/index.html",
    "build": "parcel build src/index.html --public-url ./",

Start database server and postgrest:

``` bash
dmd=~/projects/itr/itr_documentation/data_model
psk=~/codes/pg/khumbuicefall
cd $psk
docker-compose up -d
``` 

Edit `ex/cyclejs_vrp/ex08/src/index.js`

``` js
import onionify from 'cycle-onionify';
import storageify from 'cycle-storageify';
import storageDriver from '@cycle/storage';
...
const wrappedMain = onionify(storageify(main, { key: 'mpc-state' }));
...
const drivers = {
  storage: storageDriver,
  ...
run(wrappedMain, drivers);
``` 

Edit `ex/cyclejs_vrp/ex08/src/components/app/index.js`

``` js
...
  const parentReducer$ = model(sources.HTTP);
  const reducer$ = xs.merge(
    parentReducer$
  );
  const state$ = sources.onion.state$;
  const vdom$ = view(state$);
  return {
    DOM: vdom$,
    HTTP: intent(sources.DOM),
    onion: reducer$,
  };
``` 

Edit `ex/cyclejs_vrp/ex08/src/components/app/model.js`

``` js
...
  const responseReducer$ = response$.map(
    response => (prevState) => ({
      body: response.body
    })
  );
  return xs.merge(responseReducer$);
``` 

Edit `ex/cyclejs_vrp/ex08/src/components/app/view.js`

``` js
...
export default function view(state$) {
  return state$.map(({body}) =>
    ...
      tbody(
        body.map(e => 
          tr([
            td(e.plan_id),
``` 

### v09: Make Page Layout and Add New Components

``` bash
mkdir -p ex/cyclejs_vrp/ex09 && cd $_ && npm init -y && pnpm i --save-dev parcel-bundler && npm i xstream @cycle/run @cycle/dom @cycle/http cycle-onionify cycle-storageify @cycle/storage typestyle bootstrap jquery jquery-ui-dist popper.js
``` 

``` {bash}
cp -R ex/cyclejs_vrp/ex08/src/ ex/cyclejs_vrp/ex09/src/ 
``` 

`ex/cyclejs_vrp/ex09/package.json`

    "start": "parcel src/index.html",
    "build": "parcel build src/index.html --public-url ./",

Start database server and postgrest:

``` bash
dmd=~/projects/itr/itr_documentation/data_model
psk=~/codes/pg/khumbuicefall
cd $psk
docker-compose up -d
``` 

Edit `ex/cyclejs_vrp/ex09/src/components/app/index.js`

``` js
import "./import_jquery";
...
import PlanPanel from '../plan_panel';
...
  const vdom$ = xs.combine(
    Header(),
    PlanPanel(state$),
  ).map( ([header, plan_panel]) =>
    div(
      [
        header,
        plan_panel,
      ]
    )
  )
  ...
``` 

Edit `ex/cyclejs_vrp/ex09/src/import_jquery.js`

``` js
import jquery from "jquery";
export default (window.$ = window.jQuery = jquery);
import 'bootstrap';
import 'bootstrap/dist/css/bootstrap.min.css';
``` 

Edit `ex09/src/components/plan_panel/index.js`

``` js
export default function PlanPanel(state$) {
  const panel_vdom$ = state$.map( ({body}) =>
    article("#plan_panel.card", [
    ...
            tbody(
              body.map(e => 
                tr([
                  td(e.plan_id),
                  td(e.usr),
                  ...
``` 

### v10: Bootstrap + CycleJs Base Example

``` bash
mkdir -p ex/cyclejs_vrp/ex10 && cd $_ && npm init -y && pnpm i --save-dev parcel-bundler && npm i xstream @cycle/run @cycle/dom @cycle/http cycle-onionify cycle-storageify @cycle/storage typestyle bootstrap jquery jquery-ui-dist popper.js
``` 

``` {bash}
cp -R ex/cyclejs_vrp/ex09/src/ ex/cyclejs_vrp/ex10/src/ 
``` 

`ex/cyclejs_vrp/ex10/package.json`

    "start": "parcel src/index.html",
    "build": "parcel build src/index.html --public-url ./",

Edit `ex/cyclejs_vrp/ex10/src/components/plan_panel/index.js`

``` js
  const panel_vdom$ = state$.map( ({body}) =>
    article("#plan_panel.card", [
      ul("#planlama.nav.nav-tabs", {
        "attrs": {
          "role": "tablist",
        },
    ...
``` 

Note that DOM attributes/properties are nested under `"attrs"` object.

Run `npm start`
 
Open http://localhost:1234

### v11: Parcel + CycleJs Simplest Example

``` bash
mkdir -p ex/cyclejs_vrp/ex11 && cd $_ && npm init -y && pnpm i --save-dev parcel-bundler && npm i xstream @cycle/run @cycle/dom
``` 

`ex/cyclejs_vrp/ex11/package.json`

    "start": "parcel src/index.html",
    "build": "parcel build src/index.html --public-url ./",

Edit `ex/cyclejs_vrp/ex11/src/index.js`

Run `npm start`
 
Open http://localhost:1234

### v12: Parcel + CycleJs Simplest Example

``` bash
mkdir -p ex/cyclejs_vrp/ex12 && cd $_ && npm init -y && pnpm i --save-dev parcel-bundler && npm i xstream @cycle/run @cycle/dom
``` 

``` {bash}
cp -R ex/cyclejs_vrp/ex11/src/ ex/cyclejs_vrp/ex12/src/ 
``` 

`ex/cyclejs_vrp/ex12/package.json`

    "start": "parcel src/index.html",
    "build": "parcel build src/index.html --public-url ./",

Edit `ex/cyclejs_vrp/ex12/src/index.js`

Run `npm start`
 
Open http://localhost:1234

Generated HTML file:

### v13: Use snabbdom h with attrs + bootstrap example

``` bash
mkdir -p ex/cyclejs_vrp/ex13 && cd $_ && npm init -y && pnpm i --save-dev parcel-bundler && npm i xstream @cycle/run @cycle/dom snabbdom snabbdom-to-html
``` 

``` {bash}
cp -R ex/cyclejs_vrp/ex12/src/ ex/cyclejs_vrp/ex13/src/ 
``` 

`ex/cyclejs_vrp/ex13/package.json`

    "start": "parcel src/index.html",
    "build": "parcel build src/index.html --public-url ./",

Edit `ex/cyclejs_vrp/ex13/src/index.js`

``` js
  h("ul#myTab.nav.nav-tabs", {
    "attrs": {
      "role": "tablist",
    },
``` 

Run `npm start`
 
Open http://localhost:1234

### v14: Use snabbdom helper functions with attrs + bootstrap example

``` bash
mkdir -p ex/cyclejs_vrp/ex14 && cd $_ && npm init -y && pnpm i --save-dev parcel-bundler && npm i xstream @cycle/run @cycle/dom snabbdom snabbdom-to-html
``` 

``` {bash}
cp -R ex/cyclejs_vrp/ex13/src/ ex/cyclejs_vrp/ex14/src/ 
``` 

`ex/cyclejs_vrp/ex14/package.json`

    "start": "parcel src/index.html",
    "build": "parcel build src/index.html --public-url ./",

Edit `ex/cyclejs_vrp/ex14/src/index.js`

``` js
import "./import_jquery";
...
  ul("#myTab.nav.nav-tabs", {
    "attrs": {
      "role": "tablist",
    },
``` 

Edit `ex/cyclejs_vrp/ex14/src/import_jquery.js`

``` js
import jquery from "jquery";
export default (window.$ = window.jQuery = jquery);
import 'bootstrap';
import 'bootstrap/dist/css/bootstrap.min.css';
``` 

``` bash
npm i bootstrap jquery jquery-ui-dist popper.js
``` 

Run `npm start`
 
Open http://localhost:1234

