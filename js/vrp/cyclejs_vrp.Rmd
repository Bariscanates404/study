---
title: "CycleJS Implementation in VRP"
date: 2018-02-27T18:23:18+03:00 
draft: true
description: ""
tags:
categories: javascript, cyclejs
type: post
url:
author: "Mert Nuhoglu"
output:
  html_document:
    css: styles.css
blog: mertnuhoglu.com
resource_files:
- 
path: ~/projects/study/js/vrp/cyclejs_vrp.Rmd
state: wip
---

<style>
  .main-container {
    max-width: 1600px !important;
  }
</style>

``` {r set-options}
options(width = 150)
options(max.print = 30)
``` 

## v01: Calling and Viewing Data from a Simple REST API 

First run the web service:

``` bash
json-server --watch ex/db.json
open ex/cyclejs_vrp_ex01.html
``` 

Clicking the button results in:

<div class="app" data-vivaldi-spatnav-clickable="1"><div><button class="get-first">Get first comment</button><div class="comment-details"><h4 class="comment-body">some comment</h4><h4 class="comment-id">1</h4></div></div></div>

Note: The following code variants have different outputs:

      h4('.comment-body', firstComment.body),
      h4('.comment-id', `${firstComment.id}`)
      //h4('.comment-json', `${firstComment}`)
      //> [object Object]
      //h4('.comment-json', firstComment.id)
      //> TypeError: Cannot create property 'className' on number '1'

The code of this web page:

``` {bash}  
cat ex/cyclejs_vrp_ex01.js
``` 

## Calling a Postgrest REST API

Run the server embedded in docker container:

    $ docker-compose up -d # wait for 5-10s before running the next command

Make a basic request:

    $ curl http://localhost:8080/rest/todos?select=id
    [{"id":1},{"id":3},{"id":6}]

## Consuming Postgrest REST API in CycleJS App

``` bash
docker-compose up -d 
open ex/cyclejs_vrp_ex02.html
``` 

`ex/cyclejs_vrp_ex02.js`

``` js
function main(sources) {
  const clickEvent$ = sources.DOM
    .select('.get-first').events('click');
  
  const request$ = clickEvent$.map(() => {
    return {
      url: 'http://localhost:8080/rest/todos?select=id',
      method: 'GET',
    };
  });
  
  const response$$ = sources.HTTP
    .filter(response$ => response$.request.url ===
           'http://localhost:8080/rest/todos?select=id');
  
  const response$ = response$$.switch();
  const json$ = response$.map(response => response.body)
    .startWith(null);
  
  return {
    DOM: json$.map(json =>
      div([
        button('.get-first', 'Get first comment'),
        json === null ? null : div('.comment-details', [
          h4('.comment-id', `${json[0].id}`)
        ])
      ])
    ),
    HTTP: request$,
  };
}

const drivers = {
  DOM: makeDOMDriver('#app'),
  HTTP: makeHTTPDriver(),
}

Cycle.run(main, drivers);
``` 

The response of REST API is as follows:

    $ curl http://localhost:8080/rest/todos?select=id
    [{"id":1},{"id":3},{"id":6}]

The view code that presents this JSON data:

    h4('.comment-id', `${json[0].id}`)

After clicking the button we get:

<div class="app"><button class="get-first">Get first comment</button><div class="comment-details"><h4 class="comment-id">1</h4></div></div>

## Consuming Actual Data in CycleJS App

Start database server and postgrest:

``` bash
dmd=~/projects/itr/itr_documentation/data_model
psk=~/codes/pg/khumbuicefall
cd $psk
docker-compose up -d
``` 

Generate schema and initial data:

``` bash
cd /Users/mertnuhoglu/projects/yumltordbschema
R
``` 

``` R
test_setup()
main_rdb_to_data_step01()
#> ~/projects/itr/itr_documentation/data_model/data/view/ddl.sql
#> ~/projects/itr/itr_documentation/data_model/data/sql/sql_insert/sql_insert_enum_var.sql
``` 

Manually edit `ddl_m.sql` by moving updated lines from `ddl.sql`:

``` vim
#> ~/projects/itr/itr_documentation/data_model/data/view/ddl.sql
:%s/\<BIGINT\>/INT/
``` 

Go to R console:

``` R
main_rdb_to_data_step02()
#> ~/projects/itr/itr_documentation/data_model/data/view/data.sql
``` 

Import initial data into database to check:

``` bash
cd ~/projects/itr/itr_documentation/data_model/data/view/
psql -d app -f init.sql
``` 

Move sql files to psk `${psk}/db/src` folder:

``` bash
cp ${dmd}/data/view/ddl_m.sql ${psk}/db/src/data/vrp_ddl_m.sql
cp ${dmd}/data/sql/sql_insert/sql_insert_enum_var.sql ${psk}/db/src/sample_data
cp ${dmd}/data/sql/sql_insert/sql_insert_enum_value.sql ${psk}/db/src/sample_data
cp ${dmd}/data/view/data.sql ${psk}/db/src/sample_data/vrp_data.sql
``` 

Edit psk sql files:

    data/schema.sql
      \ir vrp_ddl_m.sql
    init.sql
      \ir sample_data/sql_insert_enum_var.sql
      \ir sample_data/sql_insert_enum_value.sql
      \ir sample_data/vrp_data.sql
    api/schema.sql
      \ir vrp_views.sql
    api/vrp_views.sql
      create or replace view plan as
      select * from data.plan;
    authorization/privileges.sql
      grant select, insert, update, delete
      on api.plan
      to webuser;

Test from console:

``` bash
export JWT_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJyb2xlIjoid2VidXNlciJ9.uSsS2cukBlM6QXe4Y0H90fsdkJSGcle9b7p_kMV1Ymk
curl -H "Authorization: Bearer $JWT_TOKEN" http://localhost:8080/rest/plan?select=plan_id
``` 

Use in cyclejs:

``` js
const request$ = clickEvent$.map(() => {
  return {
    url: 'http://localhost:8080/rest/plan?select=plan_id',
    method: 'GET',
    headers: {
      "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJyb2xlIjoid2VidXNlciJ9.uSsS2cukBlM6QXe4Y0H90fsdkJSGcle9b7p_kMV1Ymk"
``` 

``` bash
open ex/cyclejs_vrp_ex03.html
``` 

### Table with CycleJs

``` bash
open ex/cyclejs_vrp_ex04.html
``` 

### Bundle it with ParcelJs

Source code in https://github.com/mertnuhoglu/study/js/vrp/ex/cyclejs_vrp/

``` bash
mkdir -p ex/cyclejs_vrp/ex05 && cd $_ && npm init -y && npm i parcel-bundler rxjs @cycle/rxjs-run @cycle/dom @cycle/http
``` 

`ex/cyclejs_vrp/ex05/package.json`

    "start": "parcel index.html",
    "build": "parcel build index.html --public-url ./",

removed

    "start": "cycle-scripts start",
    "build": "cycle-scripts build",

`ex/cyclejs_vrp/ex05/index.js`

Run `npm start`
 
Open http://localhost:1234
